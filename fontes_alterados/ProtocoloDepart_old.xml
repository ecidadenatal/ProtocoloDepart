<?xml version="1.0" encoding="ISO-8859-1"?>
<modification>
  <name>ProtocoloDepart</name>
  <id>ProtocoloDepart</id>
  <ecidade-version>2.3.47</ecidade-version>
  
  <file path='forms/db_frmdb_depart.php'>
    <operation>
      <search><![CDATA[<!-- Plugin ProtocoloDepart -->]]></search>
      <add position="after">
        <![CDATA[
      <? if($db_opcao != 3 && $db_opcao != 33) { ?>
      <tr>
        <td title="Central de Protocolo"><strong>Central de Protocolo?</strong></td>
        <td>
          <?
            $aOpcoes = array("1" => "Sim", "0" => "Não");
            $db_opcao_central = $db_opcao;
            $resultProtocolo = $cl_protocolodepart->sql_record($cl_protocolodepart->sql_query(null, "coddepto", null, "coddepto = $coddepto"));
            if ($cl_protocolodepart->numrows > 0) {
              $aOpcoes = array("1" => "Sim");
              $db_opcao_central = 4;
            }
            db_select("protocolo_central", $aOpcoes, true, $db_opcao_central);
          ?>
        </td>
      </tr>
      <? } ?>]]>
      </add>
    </operation>
  </file>

  <file path='con1_db_depart003.php'>
    <operation>
      <search><![CDATA[include("classes/db_db_config_classe.php");]]></search>
      <add position="after">
        <![CDATA[
include("classes/db_protocolodepart_classe.php");
include("classes/db_protocolodepartdepartamentos_classe.php");

$cl_protocolodepart               = new cl_protocolodepart;
$cl_protocolodepart_departamentos = new cl_protocolodepartdepartamentos;]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* Plugin ProtocoloDepart - Parte 01 */]]></search>
      <add position="after">
        <![CDATA[
  $sqlCentral = $cl_protocolodepart->sql_query(null, "sequencial as seq_central", null, "coddepto = $coddepto");
  $rsCentral = $cl_protocolodepart->sql_record($sqlCentral);
  db_fieldsmemory($rsCentral, 0);
  
  $rsDeptos  = $cl_protocolodepart_departamentos->sql_record($cl_protocolodepart_departamentos->sql_query(null, "plugins.protocolodepartdepartamentos.sequencial as seq_depto", null, "protocolodepart = $seq_central"));
  if ($cl_protocolodepart_departamentos->numrows > 0) {

    for ($i=0; $i < $cl_protocolodepart_departamentos->numrows; $i++) { 
      
      db_fieldsmemory($rsDeptos, $i);
      $cl_protocolodepart_departamentos->excluir($seq_depto);
    }
  }
  if ($cl_protocolodepart_departamentos->erro_status == 0) {
   $sqlerro = true;
  } 

  $cl_protocolodepart->excluir($seq_central);
  if ($cl_protocolodepart->erro_status == 0) {
   $sqlerro = true;
  } ]]>
      </add>
    </operation>
  </file>

  <file path='con1_db_depart002.php'>
    <operation>
      <search><![CDATA[include("classes/db_db_config_classe.php");]]></search>
      <add position="after">
        <![CDATA[
include("classes/db_protocolodepart_classe.php");
include("classes/db_protocolodepartdepartamentos_classe.php");

$cl_protocolodepart               = new cl_protocolodepart;
$cl_protocolodepart_departamentos = new cl_protocolodepartdepartamentos;]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* Plugin ProtocoloDepart - Parte01 */]]></search>
      <add position="after">
        <![CDATA[
    if ($protocolo_central) {

      $cl_protocolodepart->sql_record($cl_protocolodepart->sql_query(null, "coddepto", null, "coddepto = $coddepto"));
      if ($cl_protocolodepart->numrows == 0) {
        $cl_protocolodepart->coddepto = $coddepto;
        $cl_protocolodepart->incluir(null);
        if ($cl_protocolodepart->erro_status == 0) {
          $sqlerro=true;
        }

        $cl_protocolodepart_departamentos->sequencial = null;
        $cl_protocolodepart_departamentos->protocolodepart = $cl_protocolodepart->sequencial;
        $cl_protocolodepart_departamentos->coddepto = $coddepto;
        $cl_protocolodepart_departamentos->incluir(null);
        if ($cl_protocolodepart_departamentos->erro_status == 0) {
          $sqlerro=true;
        }
      }
    }]]>
      </add>
    </operation>
  </file>

  <file path='con1_db_depart001.php'>
    <operation>
      <search><![CDATA[include("classes/db_db_config_classe.php");]]></search>
      <add position="after">
        <![CDATA[
include("classes/db_protocolodepart_classe.php");
include("classes/db_protocolodepartdepartamentos_classe.php");

$cl_protocolodepart               = new cl_protocolodepart;
$cl_protocolodepart_departamentos = new cl_protocolodepartdepartamentos;]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* Plugin ProtocoloDepart - Parte01 */]]></search>
      <add position="after">
        <![CDATA[
  if ($protocolo_central) {

    $cl_protocolodepart->sql_record($cl_protocolodepart->sql_query(null, "coddepto", null, "coddepto = $coddepto"));
    
    if ($cl_protocolodepart->numrows == 0) {
    
      $cl_protocolodepart->coddepto = $coddepto;
      $cl_protocolodepart->incluir(null);
      if ($cl_protocolodepart->erro_status == 0) {
        $sqlerro=true;
      }

      $cl_protocolodepart_departamentos->sequencial = null;
      $cl_protocolodepart_departamentos->protocolodepart = $cl_protocolodepart->sequencial;
      $cl_protocolodepart_departamentos->coddepto = $coddepto;
      $cl_protocolodepart_departamentos->incluir(null);
      if ($cl_protocolodepart_departamentos->erro_status == 0) {
        $sqlerro=true;
      }
    }
  }]]>
      </add>
    </operation>
  </file>

  <file path=''>
    <operation>
      <search><![CDATA[$campos = "distinct ".$campos;]]></search>
      <add position="after">
        <![CDATA[

  $whereprotocolodepart = "1=1 ";

  $whereprotocolodepart .= "and exists(select 1 
                    from plugins.protocolodepartdepartamentos pdd 
                      inner join plugins.protocolodepart pd on pd.sequencial = pdd.protocolodepart
                    where pdd.coddepto = db_depart.coddepto and (pd.sequencial in (select protocolodepart 
                                                                                  from plugins.protocolodepartdepartamentos 
                                                                                  where coddepto = ".db_getsession("DB_coddepto").") 
                                                                  or pd.coddepto = ".db_getsession("DB_coddepto")."))";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$sql = $cldb_depart->sql_query_div(null,$campos,"coddepto", " coddepto = $chave_coddepto and (limite is null or limite >= '" . date("Y-m-d",db_getsession("DB_datausu"))."') $where_instit");]]></search>
      <add position="replace">
        <![CDATA[$sql = $cldb_depart->sql_query_div(null,$campos,"coddepto", "$whereprotocolodepart and coddepto = $chave_coddepto and (limite is null or limite >= '" . date("Y-m-d",db_getsession("DB_datausu"))."') $where_instit");]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$sql = $cldb_depart->sql_query_div("",$campos,"descrdepto"," descrdepto like '$chave_descrdepto%' and (limite is null or limite >= '" . date("Y-m-d",db_getsession("DB_datausu"))."') $where_instit");]]></search>
      <add position="replace">
        <![CDATA[$sql = $cldb_depart->sql_query_div("",$campos,"descrdepto","$whereprotocolodepart and descrdepto like '$chave_descrdepto%' and (limite is null or limite >= '" . date("Y-m-d",db_getsession("DB_datausu"))."') $where_instit");]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$sql = $cldb_depart->sql_query_div("",$campos,"coddepto","$where (limite is null or limite >= '" . date("Y-m-d",db_getsession("DB_datausu"))."') $where_instit");]]></search>
      <add position="replace">
        <![CDATA[$sql = $cldb_depart->sql_query_div("",$campos,"coddepto","$whereprotocolodepart and $where (limite is null or limite >= '" . date("Y-m-d",db_getsession("DB_datausu"))."') $where_instit");]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$sql = $cldb_depart->sql_query_div("",$campos,"coddepto","(limite is null or limite >= '" . date("Y-m-d",db_getsession("DB_datausu"))."') $where_instit");]]></search>
      <add position="replace">
        <![CDATA[$sql = $cldb_depart->sql_query_div("",$campos,"coddepto","$whereprotocolodepart and (limite is null or limite >= '" . date("Y-m-d",db_getsession("DB_datausu"))."') $where_instit");]]>
      </add>
    </operation>
  </file>
</modification>
